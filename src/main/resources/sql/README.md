# 分类和匹配规则配置说明

## 📋 概述

基于提供的微信账单数据，我们创建了一套完整的分类体系和自动匹配规则，用于自动分类各种类型的消费和收入。

## 📁 文件说明

### 1. `sample_categories_and_rules.sql`
- **用途**: 基础分类和规则创建
- **内容**: 
  - 创建完整的分类树结构
  - 基础匹配规则
  - 分类路径设置

### 2. `detailed_rules.sql`
- **用途**: 详细的匹配规则配置
- **内容**:
  - 基于不同字段的匹配规则
  - 正则表达式规则
  - 优先级设置

### 3. `test_bill_data.sql`
- **用途**: 测试数据
- **内容**: 基于实际账单数据的测试记录

### 4. `rule_test_validation.sql`
- **用途**: 规则测试和验证
- **内容**: 各种查询和统计脚本

## 🏗️ 分类结构

### 支出分类 (type = 0)
```
支出/
├── 餐饮美食/
│   ├── 学校食堂
│   ├── 餐厅
│   └── 饮品
├── 购物消费/
│   ├── 综合电商
│   └── 超市
├── 交通出行/
│   └── 校园交通
├── 生活服务/
│   └── 通讯服务
├── 娱乐休闲/
│   └── 游戏
├── 教育学习/
│   └── 学校费用
├── 医疗健康/
└── 其他支出/
```

### 收入分类 (type = 1)
```
收入/
├── 工作收入/
└── 其他收入/
    └── 转账收入
```

### 转账分类 (type = 2)
```
转账/
└── 转账
```

## 🎯 匹配规则类型

### 1. 基于交易对方 (counterparty)
- **河南工业大学** → 餐饮美食 > 学校食堂
- **京东** → 购物消费 > 综合电商
- **家联华超市** → 购物消费 > 超市
- **青程出行** → 交通出行 > 校园交通
- **中国移动** → 生活服务 > 通讯服务
- **杭州游卡** → 娱乐休闲 > 游戏
- **麦克风茶** → 餐饮美食 > 饮品
- **饺子馆** → 餐饮美食 > 餐厅
- **赵一鸣** → 购物消费 > 超市

### 2. 基于交易类型 (transactionType)
- **转账** → 其他收入 > 转账收入
- **零钱提现** → 其他支出
- **扫二维码付款** → 其他支出

### 3. 基于商品说明 (product)
- **话费充值** → 生活服务 > 通讯服务
- **三国杀** → 娱乐休闲 > 游戏

### 4. 正则表达式规则
- **京东.*订单编号\\d+** → 购物消费 > 综合电商
- **条码支付.*** → 购物消费 > 超市
- **河南工业大学.*** → 教育学习 > 学校费用

## ⚙️ 规则优先级

规则按优先级从高到低执行：

1. **优先级 1-5**: 精确匹配规则
2. **优先级 10**: 基础匹配规则
3. **优先级 100**: 通用规则
4. **优先级 999**: 兜底规则

## 🚀 使用方法

### 1. 初始化数据库
```sql
-- 执行基础分类和规则
source sample_categories_and_rules.sql;

-- 执行详细规则
source detailed_rules.sql;

-- 插入测试数据
source test_bill_data.sql;
```

### 2. 验证规则效果
```sql
-- 执行验证脚本
source rule_test_validation.sql;
```

### 3. 查看分类结果
```sql
-- 查看所有分类
SELECT * FROM bill_category ORDER BY type, level, sort;

-- 查看所有规则
SELECT * FROM category_rule ORDER BY priority ASC;
```

## 📊 预期分类结果

基于提供的测试数据，预期分类结果如下：

| 交易对方 | 金额 | 预期分类 |
|---------|------|----------|
| 河南工业大学 | 8.80, 12.00, 7.60, 14.80, 8.00, 9.50, 14.00, 5.00, 14.00, 12.00, 10.50 | 餐饮美食 > 学校食堂 |
| 京东 | 19.90, 11.99, 8.89 | 购物消费 > 综合电商 |
| 家联华超市 | 3.80, 2.00 | 购物消费 > 超市 |
| 青程出行 | 1.00 | 交通出行 > 校园交通 |
| 中国移动 | 30.00 | 生活服务 > 通讯服务 |
| 杭州游卡 | 6.00 | 娱乐休闲 > 游戏 |
| 麦克风茶 | 9.00 | 餐饮美食 > 饮品 |
| 饺子馆 | 18.00 | 餐饮美食 > 餐厅 |
| 赵一鸣 | 26.61 | 购物消费 > 超市 |
| 转账 | 1300.00, 200.00 | 其他收入 > 转账收入 |
| 零钱提现 | 400.40, 424.02 | 其他支出 |
| 扫二维码付款 | 11.00, 10.00 | 其他支出 |

## 🔧 自定义规则

### 添加新规则
```sql
INSERT INTO category_rule (
    rule_name, description, keyword, match_type, 
    first_category_id, second_category_id, priority, 
    is_enabled, is_system, create_time, update_time
) VALUES (
    '新规则名称', '规则描述', '关键词', 1,
    (SELECT id FROM bill_category WHERE category_name = '一级分类'),
    (SELECT id FROM bill_category WHERE category_name = '二级分类'),
    10, 1, 0, NOW(), NOW()
);
```

### 修改规则优先级
```sql
UPDATE category_rule 
SET priority = 5, update_time = NOW() 
WHERE rule_name = '规则名称';
```

### 禁用规则
```sql
UPDATE category_rule 
SET is_enabled = 0, update_time = NOW() 
WHERE rule_name = '规则名称';
```

## 📈 性能优化建议

1. **规则优先级**: 将最常用的规则设置更高的优先级
2. **索引优化**: 在 `counterparty`, `product`, `transaction_type` 字段上创建索引
3. **缓存机制**: 使用 `CategoryRuleHolder` 缓存规则，减少数据库查询
4. **批量处理**: 在导入大量数据时，使用批量处理提高效率

## 🐛 故障排除

### 规则不生效
1. 检查规则是否启用 (`is_enabled = 1`)
2. 检查规则优先级设置
3. 检查关键词匹配是否正确
4. 查看规则统计信息 (`match_count`, `success_count`)

### 分类错误
1. 检查分类是否存在
2. 检查分类路径是否正确
3. 检查规则匹配字段设置
4. 查看规则执行日志

## 📝 注意事项

1. **规则冲突**: 避免创建冲突的规则
2. **性能影响**: 规则过多可能影响性能
3. **数据一致性**: 修改规则后需要更新相关数据
4. **备份**: 修改前请备份重要数据
