<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>修复验证 - 微信财务监控系统</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <header class="app-header">
        <h1>修复验证</h1>
        <nav class="nav">
            <a href="/import-sessions.html">导入批次管理</a>
        </nav>
    </header>
    <main class="container">
        <section class="card">
            <h2>修复验证</h2>
            <div class="toolbar">
                <button class="btn" onclick="testNumberFormat()">测试数字格式</button>
                <button class="btn" onclick="testTableAlignment()">测试表格对齐</button>
            </div>
            <div id="test-results" style="background: #1a1a1a; padding: 16px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; margin-top: 16px;"></div>
        </section>
        
        <section class="card">
            <h2>模拟数据测试</h2>
            <div id="mock-data"></div>
        </section>
    </main>

    <script src="/utils.js"></script>
    <script>
    function log(message) {
        const results = document.getElementById('test-results');
        const timestamp = new Date().toLocaleTimeString();
        results.textContent += `[${timestamp}] ${message}\n`;
        results.scrollTop = results.scrollHeight;
        console.log(message);
    }

    function testNumberFormat() {
        log('测试数字格式...');
        
        // 测试概览数据格式
        const mockStats = {
            total_sessions: 15,
            total_rows: 2450,
            total_inserted: 2320,
            total_duplicates: 89,
            total_errors: 41,
            success_rate: 94.7
        };
        
        log('原始数据: ' + JSON.stringify(mockStats));
        log('格式化后:');
        log('  总导入批次: ' + (mockStats.total_sessions || 0));
        log('  总导入行数: ' + (mockStats.total_rows || 0).toLocaleString());
        log('  成功导入: ' + (mockStats.total_inserted || 0).toLocaleString());
        log('  重复行数: ' + (mockStats.total_duplicates || 0).toLocaleString());
        log('  错误行数: ' + (mockStats.total_errors || 0).toLocaleString());
        log('  成功率: ' + (mockStats.success_rate || 0).toFixed(1) + '%');
        
        log('✅ 数字格式测试完成 - 没有￥符号');
    }

    function testTableAlignment() {
        log('测试表格对齐...');
        
        const mockSessions = [
            {
                id: 1,
                fileName: '微信支付账单(2024-10-01).xlsx',
                sourceType: '微信账单xlsx',
                totalRows: 100,
                insertedRows: 95,
                duplicateRows: 3,
                errorRows: 2,
                importTime: '2024-10-01 10:30:00'
            },
            {
                id: 2,
                fileName: '微信支付账单(2024-10-02).xlsx',
                sourceType: '微信账单xlsx',
                totalRows: 150,
                insertedRows: 148,
                duplicateRows: 1,
                errorRows: 1,
                importTime: '2024-10-02 14:20:00'
            }
        ];
        
        // 渲染模拟表格
        const container = document.getElementById('mock-data');
        container.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox"></th>
                        <th>批次ID</th>
                        <th>文件名</th>
                        <th>文件类型</th>
                        <th>总行数</th>
                        <th>成功导入</th>
                        <th>重复行</th>
                        <th>错误行</th>
                        <th>成功率</th>
                        <th>状态</th>
                        <th>导入时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${mockSessions.map(session => {
                        const successRate = session.totalRows > 0 ? 
                            (session.insertedRows * 100 / session.totalRows) : 0;
                        const status = successRate >= 95 ? 
                            { class: 'success', text: '成功' } : 
                            successRate >= 50 ? 
                            { class: 'warning', text: '部分成功' } : 
                            { class: 'error', text: '失败' };
                        
                        return `
                            <tr>
                                <td><input type="checkbox"></td>
                                <td>${session.id}</td>
                                <td title="${session.fileName}">${session.fileName.length > 30 ? session.fileName.substring(0, 30) + '...' : session.fileName}</td>
                                <td>${session.sourceType}</td>
                                <td>${session.totalRows}</td>
                                <td class="success">${session.insertedRows}</td>
                                <td class="warning">${session.duplicateRows}</td>
                                <td class="error">${session.errorRows}</td>
                                <td>
                                    <span class="success-rate ${successRate >= 95 ? 'success' : successRate >= 50 ? 'warning' : 'error'}">
                                        ${successRate.toFixed(1)}%
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge ${status.class}">${status.text}</span>
                                </td>
                                <td>${new Date(session.importTime).toLocaleDateString()}</td>
                                <td>
                                    <a href="#" class="action-link">详情</a>
                                    <span class="muted"> | </span>
                                    <a href="#" class="action-link danger">删除</a>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
        
        log('✅ 表格对齐测试完成 - 状态和操作列应该在同一行');
    }

    // 页面加载时自动运行测试
    window.addEventListener('load', () => {
        log('页面加载完成，开始验证修复...');
        testNumberFormat();
        testTableAlignment();
    });
    </script>
</body>
</html>
