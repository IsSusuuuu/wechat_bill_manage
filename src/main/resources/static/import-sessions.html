<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å¯¼å…¥æ‰¹æ¬¡ç®¡ç† - å¾®ä¿¡è´¢åŠ¡ç›‘æ§ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
    :root { --apple-bg: #f5f5f7; --apple-card: #ffffff; --apple-text: #1d1d1f; --apple-text-secondary: #86868b; --apple-border: #d2d2d7; --apple-blue: #007aff; --apple-blue-hover: #0051d5; --apple-shadow: 0 2px 10px rgba(0,0,0,0.06); --apple-shadow-hover: 0 4px 20px rgba(0,0,0,0.1); --apple-danger: #ff3b30; --apple-success: #34c759; --apple-warning: #ff9500; --apple-gray: #f5f5f7; }
    * { box-sizing: border-box; }
    html,body { margin:0; padding:0; background:var(--apple-bg); color:var(--apple-text); font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Helvetica Neue",sans-serif; }
    .app-header { display:flex; align-items:center; justify-content:space-between; padding:16px 24px; background:rgba(255,255,255,0.8); backdrop-filter:saturate(180%) blur(20px); border-bottom:1px solid rgba(0,0,0,0.08); position:sticky; top:0; z-index:10; }
    .app-header h1 { font-size:20px; margin:0; font-weight:600; letter-spacing:-0.3px; }
    .nav { display:flex; gap:8px; }
    .nav a { color:var(--apple-text-secondary); text-decoration:none; padding:8px 12px; border-radius:8px; border:1px solid transparent; transition:all 0.2s ease; font-weight:400; }
    .nav a:hover { background:rgba(0,0,0,0.04); color:var(--apple-text); }
    .nav a.active { color:var(--apple-blue); font-weight:500; background:rgba(0,122,255,0.08); }
    .container { max-width:1400px; margin:32px auto; padding:0 24px; }
    .card { background:var(--apple-card); border:1px solid rgba(0,0,0,0.04); border-radius:16px; padding:24px; margin-bottom:24px; box-shadow:var(--apple-shadow); transition:all 0.3s ease; }
    .card:hover { box-shadow:var(--apple-shadow-hover); }
    .card h2 { margin:0 0 16px 0; font-size:20px; font-weight:600; letter-spacing:-0.3px; }
    #summary { display:grid; grid-template-columns:repeat(6,1fr); gap:16px; }
    .kpi { background:var(--apple-card); border:1px solid var(--apple-border); border-radius:12px; padding:20px; transition:all 0.2s ease; }
    .kpi:hover { transform:translateY(-2px); box-shadow:var(--apple-shadow); }
    .kpi-title { color:var(--apple-text-secondary); font-size:14px; font-weight:500; margin-bottom:8px; }
    .kpi-value { font-size:28px; font-weight:700; color:var(--apple-text); letter-spacing:-0.5px; }
    .btn { display:inline-block; color:white; background:var(--apple-blue); padding:10px 20px; border-radius:10px; text-decoration:none; font-weight:500; transition:all 0.2s ease; border:none; cursor:pointer; font-size:14px; }
    .btn:hover { background:var(--apple-blue-hover); transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,122,255,0.3); }
    .btn:active { transform:translateY(0); }
    .toolbar { display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
    .toolbar input,.toolbar select { background:var(--apple-card); color:var(--apple-text); border:1px solid var(--apple-border); padding:10px 16px; border-radius:10px; font-size:14px; transition:all 0.2s ease; }
    .toolbar input:focus,.toolbar select:focus { outline:none; border-color:var(--apple-blue); box-shadow:0 0 0 3px rgba(0,122,255,0.1); }
    .toolbar .btn-secondary { color:var(--apple-text); background:var(--apple-card); border:1px solid var(--apple-border); }
    .toolbar .btn-secondary:hover { background:var(--apple-gray); }
    .toolbar .btn-secondary:disabled,.toolbar .btn-danger:disabled { opacity:0.5; cursor:not-allowed; transform:none !important; }
    .toolbar .btn-danger { color:#fff; background:var(--apple-danger); border:1px solid var(--apple-danger); }
    .toolbar .btn-danger:hover { background:#d63031; }
    table { width:100%; border-collapse:collapse; background:var(--apple-card); border-radius:12px; overflow:hidden; }
    th,td { text-align:left; border-bottom:1px solid var(--apple-border); padding:12px 16px; font-size:13px; }
    th { color:var(--apple-text-secondary); font-weight:600; font-size:13px; text-transform:none; letter-spacing:-0.1px; background:var(--apple-gray); }
    tbody tr:hover { background:rgba(0,0,0,0.02); }
    .dialog { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); z-index:1000; }
    .dialog.open { display:flex; }
    .dialog-panel { width:560px; max-width:92vw; background:var(--apple-card); border:1px solid rgba(0,0,0,0.04); border-radius:20px; padding:24px; box-shadow:0 10px 40px rgba(0,0,0,0.15); }
    .dialog-title { margin:0 0 20px 0; font-size:20px; font-weight:600; letter-spacing:-0.3px; }
    .dialog-actions { display:flex; justify-content:flex-end; gap:12px; margin-top:24px; }
    .success { color:var(--apple-success); font-weight:600; }
    .warning { color:var(--apple-warning); font-weight:600; }
    .error { color:var(--apple-danger); font-weight:600; }
    .success-rate { padding:4px 8px; border-radius:6px; font-size:12px; font-weight:600; }
    .success-rate.success { background:rgba(52,199,89,0.1); color:var(--apple-success); }
    .success-rate.warning { background:rgba(255,149,0,0.1); color:var(--apple-warning); }
    .success-rate.error { background:rgba(255,59,48,0.1); color:var(--apple-danger); }
    .status-badge { padding:4px 10px; border-radius:8px; font-size:12px; font-weight:600; }
    .status-badge.success { background:rgba(52,199,89,0.1); color:var(--apple-success); }
    .status-badge.warning { background:rgba(255,149,0,0.1); color:var(--apple-warning); }
    .status-badge.error { background:rgba(255,59,48,0.1); color:var(--apple-danger); }
    tr.selected { background:rgba(0,122,255,0.08); }
    tr.selected td { border-color:rgba(0,122,255,0.2); }
    #batch-actions { border:1px solid rgba(0,122,255,0.2); background:rgba(0,122,255,0.05); }
    #batch-actions span { font-weight:600; color:var(--apple-blue); }
    @media (max-width:1200px) { #summary { grid-template-columns:repeat(3,1fr); } }
    @media (max-width:768px) { #summary { grid-template-columns:1fr; } .container { margin:20px auto; padding:0 16px; } .card { padding:20px; border-radius:12px; } .toolbar { flex-direction:column; align-items:stretch; } .toolbar > * { width:100%; } table { font-size:12px; } .kpi { min-width:120px; } .app-header { flex-direction:column; align-items:flex-start; gap:12px; } .nav { width:100%; flex-wrap:wrap; } }
    </style>
</head>
<body>
    <header class="app-header">
        <h1>å¯¼å…¥æ‰¹æ¬¡ç®¡ç†</h1>
        <nav class="nav">
            <a href="/index.html">é¦–é¡µ</a>
            <a href="/categories.html">æ”¶æ”¯åˆ†ç±»</a>
            <a href="/rules.html">è‡ªåŠ¨å¡«å……è§„åˆ™</a>
            <a href="/import.html">è´¦å•å¯¼å…¥</a>
            <a href="/import-sessions.html" class="active">å¯¼å…¥æ‰¹æ¬¡</a>
            <a href="/reports.html">åˆ†ææŠ¥è¡¨</a>
        </nav>
    </header>
    <main class="container">
        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <section class="card">
            <h2>å¯¼å…¥ç»Ÿè®¡æ¦‚è§ˆ</h2>
            <div id="summary">
                <div class="kpi"><div class="kpi-title">æ€»å¯¼å…¥æ‰¹æ¬¡</div><div class="kpi-value" id="kpi-sessions">-</div></div>
                <div class="kpi"><div class="kpi-title">æ€»å¯¼å…¥è¡Œæ•°</div><div class="kpi-value" id="kpi-rows">-</div></div>
                <div class="kpi"><div class="kpi-title">æˆåŠŸå¯¼å…¥</div><div class="kpi-value" id="kpi-inserted">-</div></div>
                <div class="kpi"><div class="kpi-title">é‡å¤è¡Œæ•°</div><div class="kpi-value" id="kpi-duplicates">-</div></div>
                <div class="kpi"><div class="kpi-title">é”™è¯¯è¡Œæ•°</div><div class="kpi-value" id="kpi-errors">-</div></div>
                <div class="kpi"><div class="kpi-title">æˆåŠŸç‡</div><div class="kpi-value" id="kpi-success-rate">-</div></div>
            </div>
        </section>

        <!-- å¯¼å…¥æ‰¹æ¬¡åˆ—è¡¨ -->
        <section class="card">
            <h2>å¯¼å…¥æ‰¹æ¬¡åˆ—è¡¨</h2>
            <div class="toolbar">
                <button class="btn" onclick="loadImportSessions()">ğŸ”„ åˆ·æ–°</button>
                <button class="btn-secondary" onclick="loadImportTrends()">ğŸ“Š è¶‹åŠ¿åˆ†æ</button>
                <button class="btn-secondary" onclick="exportSessions()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                <button class="btn-secondary" onclick="resetDateFilter()">ğŸ“… é‡ç½®æ—¥æœŸ</button>
                <select id="filter-status" onchange="filterSessions()">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="success">æˆåŠŸ</option>
                    <option value="warning">éƒ¨åˆ†æˆåŠŸ</option>
                    <option value="error">å¤±è´¥</option>
                </select>
                <input type="date" id="filter-date-from" placeholder="å¼€å§‹æ—¥æœŸ" onchange="filterSessions()" title="å¼€å§‹æ—¥æœŸï¼ˆé»˜è®¤æœ¬æœˆç¬¬ä¸€å¤©ï¼‰">
                <input type="date" id="filter-date-to" placeholder="ç»“æŸæ—¥æœŸ" onchange="filterSessions()" title="ç»“æŸæ—¥æœŸï¼ˆé»˜è®¤ä»Šå¤©ï¼‰">
                <input type="text" id="search-sessions" placeholder="æœç´¢æ–‡ä»¶å..." oninput="filterSessions()">
            </div>
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-sessions" onchange="toggleSelectAll()"></th>
                        <th>æ‰¹æ¬¡ID</th>
                        <th>æ–‡ä»¶å</th>
                        <th>æ–‡ä»¶ç±»å‹</th>
                        <th>æ€»è¡Œæ•°</th>
                        <th>æˆåŠŸå¯¼å…¥</th>
                        <th>é‡å¤è¡Œ</th>
                        <th>é”™è¯¯è¡Œ</th>
                        <th>æˆåŠŸç‡</th>
                        <th>çŠ¶æ€</th>
                        <th>å¯¼å…¥æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="sessions-tbody"></tbody>
            </table>
            
            <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
            <div id="batch-actions" class="toolbar" style="display: none; margin-top: 10px; padding: 10px; background: #1a1a1a; border-radius: 8px;">
                <span id="selected-count">å·²é€‰æ‹© 0 ä¸ªæ‰¹æ¬¡</span>
                <button class="btn-secondary" onclick="batchReprocess()">é‡æ–°å¤„ç†</button>
                <button class="btn-danger" onclick="batchDelete()">æ‰¹é‡åˆ é™¤</button>
                <button class="btn-secondary" onclick="batchExport()">æ‰¹é‡å¯¼å‡º</button>
                <button class="btn-secondary" onclick="clearSelection()">å–æ¶ˆé€‰æ‹©</button>
            </div>
        </section>

        <!-- æ‰¹æ¬¡è¯¦æƒ…å¯¹è¯æ¡† -->
        <div class="dialog" id="dlg-session-detail">
            <div class="dialog-panel">
                <h3 class="dialog-title">æ‰¹æ¬¡è¯¦æƒ…</h3>
                <div id="session-detail-content"></div>
                <div class="dialog-actions">
                    <button class="btn-secondary" onclick="closeDialog('dlg-session-detail')">å…³é—­</button>
                    <button class="btn-danger" id="btn-delete-session" style="display: none;">åˆ é™¤æ‰¹æ¬¡</button>
                    <button class="btn" id="btn-reprocess-session" style="display: none;">é‡æ–°å¤„ç†</button>
                </div>
            </div>
        </div>

        <!-- è¶‹åŠ¿åˆ†æå¯¹è¯æ¡† -->
        <div class="dialog" id="dlg-trends">
            <div class="dialog-panel" style="width: 800px;">
                <h3 class="dialog-title">å¯¼å…¥è¶‹åŠ¿åˆ†æ</h3>
                <div id="trends-content"></div>
                <div class="dialog-actions">
                    <button class="btn-secondary" onclick="closeDialog('dlg-trends')">å…³é—­</button>
                </div>
            </div>
        </div>
    </main>

    <script src="/utils.js"></script>
    <script>
    const api = {
        sessions: '/api/import-sessions',
        statistics: '/api/import-sessions/statistics',
        trends: '/api/import-sessions/trends'
    };
    
    let currentSessionId = null;
    let allSessions = [];
    let filteredSessions = [];
    let selectedSessions = new Set();
    
    // åŠ è½½å¯¼å…¥ç»Ÿè®¡
    async function loadStatistics() {
        try {
            const result = await fetchJson(api.statistics);
            if (result.code === 1) {
                const data = result.data;
                document.getElementById('kpi-sessions').textContent = data.total_sessions || 0;
                document.getElementById('kpi-rows').textContent = (data.total_rows || 0).toLocaleString();
                document.getElementById('kpi-inserted').textContent = (data.total_inserted || 0).toLocaleString();
                document.getElementById('kpi-duplicates').textContent = (data.total_duplicates || 0).toLocaleString();
                document.getElementById('kpi-errors').textContent = (data.total_errors || 0).toLocaleString();
                document.getElementById('kpi-success-rate').textContent = 
                    (data.success_rate || 0).toFixed(1) + '%';
            }
        } catch (error) {
            console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
        }
    }
    
    // åŠ è½½å¯¼å…¥æ‰¹æ¬¡åˆ—è¡¨
    async function loadImportSessions() {
        try {
            showLoading('sessions-tbody', 'æ­£åœ¨åŠ è½½å¯¼å…¥æ‰¹æ¬¡...');
            const result = await fetchJson(api.sessions);
            if (result.code === 1) {
                allSessions = result.data || [];
                filterSessions();
            } else {
                console.error('åŠ è½½å¯¼å…¥æ‰¹æ¬¡å¤±è´¥:', result.msg);
                showError('sessions-tbody', 'åŠ è½½å¤±è´¥ï¼š' + result.msg);
            }
        } catch (error) {
            console.error('åŠ è½½å¯¼å…¥æ‰¹æ¬¡å¤±è´¥:', error);
            showError('sessions-tbody', 'åŠ è½½å¤±è´¥ï¼š' + error.message);
        }
    }
    
    // è¿‡æ»¤å’Œæœç´¢æ‰¹æ¬¡
    function filterSessions() {
        const searchTerm = document.getElementById('search-sessions').value.toLowerCase();
        const statusFilter = document.getElementById('filter-status').value;
        const dateFrom = document.getElementById('filter-date-from').value;
        const dateTo = document.getElementById('filter-date-to').value;
        
        filteredSessions = allSessions.filter(session => {
            // æœç´¢è¿‡æ»¤
            const matchesSearch = !searchTerm || 
                (session.fileName || '').toLowerCase().includes(searchTerm) ||
                (session.sourceType || '').toLowerCase().includes(searchTerm);
            
            // çŠ¶æ€è¿‡æ»¤
            let matchesStatus = true;
            if (statusFilter) {
                const successRate = session.totalRows > 0 ? 
                    (session.insertedRows * 100 / session.totalRows) : 0;
                if (statusFilter === 'success') {
                    matchesStatus = successRate >= 95;
                } else if (statusFilter === 'warning') {
                    matchesStatus = successRate >= 50 && successRate < 95;
                } else if (statusFilter === 'error') {
                    matchesStatus = successRate < 50;
                }
            }
            
            // æ—¥æœŸè¿‡æ»¤
            let matchesDate = true;
            if (dateFrom || dateTo) {
                const sessionDate = new Date(session.importTime);
                if (dateFrom) {
                    matchesDate = matchesDate && sessionDate >= new Date(dateFrom);
                }
                if (dateTo) {
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    matchesDate = matchesDate && sessionDate <= toDate;
                }
            }
            
            return matchesSearch && matchesStatus && matchesDate;
        });
        
        renderSessions(filteredSessions);
    }
    
    // æ¸²æŸ“å¯¼å…¥æ‰¹æ¬¡åˆ—è¡¨
    function renderSessions(sessions) {
        const tbody = document.getElementById('sessions-tbody');
        
        if (sessions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" class="muted">æš‚æ— æ•°æ®</td></tr>';
            return;
        }
        
        const rows = sessions.map(session => {
            const successRate = session.totalRows > 0 ? 
                (session.insertedRows * 100 / session.totalRows) : 0;
            const status = getSessionStatus(successRate);
            const isSelected = selectedSessions.has(session.id);
            
            return `
                <tr class="${isSelected ? 'selected' : ''}">
                    <td>
                        <input type="checkbox" ${isSelected ? 'checked' : ''} 
                               onchange="toggleSessionSelection(${session.id})">
                    </td>
                    <td>${session.id}</td>
                    <td title="${session.fileName || '-'}">${truncateText(session.fileName || '-', 30)}</td>
                    <td>${session.sourceType || '-'}</td>
                    <td>${session.totalRows || 0}</td>
                    <td class="success">${session.insertedRows || 0}</td>
                    <td class="warning">${session.duplicateRows || 0}</td>
                    <td class="error">${session.errorRows || 0}</td>
                    <td>
                        <span class="success-rate ${successRate >= 95 ? 'success' : successRate >= 50 ? 'warning' : 'error'}">
                            ${successRate.toFixed(1)}%
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${status.class}">${status.text}</span>
                    </td>
                    <td title="${formatDateTime(session.importTime)}">${formatDate(session.importTime)}</td>
                    <td>
                        <a href="#" onclick="showSessionDetail(${session.id})" class="action-link">è¯¦æƒ…</a>
                        <span class="muted"> | </span>
                        <a href="#" onclick="deleteSession(${session.id})" class="action-link danger">åˆ é™¤</a>
                    </td>
                </tr>
            `;
        }).join('');
        
        tbody.innerHTML = rows;
        updateBatchActions();
    }
    
    // è·å–æ‰¹æ¬¡çŠ¶æ€
    function getSessionStatus(successRate) {
        if (successRate >= 95) {
            return { class: 'success', text: 'æˆåŠŸ' };
        } else if (successRate >= 50) {
            return { class: 'warning', text: 'éƒ¨åˆ†æˆåŠŸ' };
        } else {
            return { class: 'error', text: 'å¤±è´¥' };
        }
    }
    
    // æˆªæ–­æ–‡æœ¬
    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateTimeStr) {
        if (!dateTimeStr) return '-';
        try {
            const date = new Date(dateTimeStr);
            return date.toLocaleDateString('zh-CN');
        } catch (e) {
            return dateTimeStr;
        }
    }
    
    // æ˜¾ç¤ºæ‰¹æ¬¡è¯¦æƒ…
    async function showSessionDetail(sessionId) {
        try {
            const result = await fetchJson(`${api.sessions}/${sessionId}`);
            if (result.code === 1) {
                const session = result.data;
                currentSessionId = sessionId;
                
                // æ˜¾ç¤ºæ‰¹æ¬¡åŸºæœ¬ä¿¡æ¯
                const detailContent = `
                    <div class="form-grid">
                        <label>æ‰¹æ¬¡ID: ${session.id}</label>
                        <label>æ–‡ä»¶å: ${session.fileName || '-'}</label>
                        <label>æ–‡ä»¶ç±»å‹: ${session.sourceType || '-'}</label>
                        <label>æ€»è¡Œæ•°: ${session.totalRows || 0}</label>
                        <label>æˆåŠŸå¯¼å…¥: ${session.insertedRows || 0}</label>
                        <label>é‡å¤è¡Œæ•°: ${session.duplicateRows || 0}</label>
                        <label>é”™è¯¯è¡Œæ•°: ${session.errorRows || 0}</label>
                        <label>å¯¼å…¥æ—¶é—´: ${formatDateTime(session.importTime)}</label>
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn" onclick="loadSessionBills(${sessionId})">æŸ¥çœ‹è´¦å•æ•°æ®</button>
                    </div>
                    <div id="session-bills" style="margin-top: 16px;"></div>
                `;
                
                document.getElementById('session-detail-content').innerHTML = detailContent;
                document.getElementById('btn-delete-session').style.display = 'inline-block';
                document.getElementById('btn-reprocess-session').style.display = 'inline-block';
                openDialog('dlg-session-detail');
            }
        } catch (error) {
            console.error('è·å–æ‰¹æ¬¡è¯¦æƒ…å¤±è´¥:', error);
            toast('è·å–æ‰¹æ¬¡è¯¦æƒ…å¤±è´¥ï¼š' + error.message);
        }
    }
    
    // åŠ è½½æ‰¹æ¬¡è´¦å•æ•°æ®
    async function loadSessionBills(sessionId) {
        try {
            const result = await fetchJson(`${api.sessions}/${sessionId}/bills`);
            if (result.code === 1) {
                const bills = result.data || [];
                renderSessionBills(bills);
            }
        } catch (error) {
            console.error('è·å–æ‰¹æ¬¡è´¦å•å¤±è´¥:', error);
        }
    }
    
    // æ¸²æŸ“æ‰¹æ¬¡è´¦å•æ•°æ®
    function renderSessionBills(bills) {
        const container = document.getElementById('session-bills');
        
        if (bills.length === 0) {
            container.innerHTML = '<p class="muted">è¯¥æ‰¹æ¬¡æš‚æ— è´¦å•æ•°æ®</p>';
            return;
        }
        
        const table = `
            <table style="margin-top: 16px;">
                <thead>
                    <tr>
                        <th>è¡Œå·</th>
                        <th>äº¤æ˜“æ—¶é—´</th>
                        <th>äº¤æ˜“ç±»å‹</th>
                        <th>äº¤æ˜“å¯¹æ–¹</th>
                        <th>é‡‘é¢</th>
                        <th>åˆ†ç±»</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody>
                    ${bills.map(bill => `
                        <tr>
                            <td>${bill.row_index || '-'}</td>
                            <td>${formatDateTime(bill.transaction_time)}</td>
                            <td>${bill.transaction_type || '-'}</td>
                            <td>${bill.counterparty || '-'}</td>
                            <td>${toCurrency(bill.amount || 0)}</td>
                            <td>${bill.first_category_name || ''}${bill.second_category_name ? ' > ' + bill.second_category_name : ''}</td>
                            <td>${bill.status || '-'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        container.innerHTML = table;
    }
    
    // åˆ é™¤æ‰¹æ¬¡
    async function deleteSession(sessionId) {
        if (!confirm('ç¡®è®¤åˆ é™¤è¯¥å¯¼å…¥æ‰¹æ¬¡ï¼Ÿè¿™å°†åˆ é™¤è¯¥æ‰¹æ¬¡çš„æ‰€æœ‰è´¦å•æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            return;
        }
        
        try {
            const result = await fetchJson(`${api.sessions}/${sessionId}`, { method: 'DELETE' });
            if (result.code === 1) {
                toast('åˆ é™¤æˆåŠŸ');
                closeDialog('dlg-session-detail');
                loadImportSessions();
                loadStatistics();
            } else {
                toast('åˆ é™¤å¤±è´¥ï¼š' + result.msg);
            }
        } catch (error) {
            console.error('åˆ é™¤æ‰¹æ¬¡å¤±è´¥:', error);
            toast('åˆ é™¤å¤±è´¥ï¼š' + error.message);
        }
    }
    
    // é‡æ–°å¤„ç†æ‰¹æ¬¡
    async function reprocessSession(sessionId) {
        if (!confirm('ç¡®è®¤é‡æ–°å¤„ç†è¯¥å¯¼å…¥æ‰¹æ¬¡ï¼Ÿ')) {
            return;
        }
        
        try {
            const result = await fetchJson(`${api.sessions}/${sessionId}/reprocess`, { method: 'POST' });
            if (result.code === 1) {
                toast('é‡æ–°å¤„ç†å®Œæˆ');
                loadImportSessions();
                loadStatistics();
            } else {
                toast('é‡æ–°å¤„ç†å¤±è´¥ï¼š' + result.msg);
            }
        } catch (error) {
            console.error('é‡æ–°å¤„ç†å¤±è´¥:', error);
            toast('é‡æ–°å¤„ç†å¤±è´¥ï¼š' + error.message);
        }
    }
    
    // åŠ è½½è¶‹åŠ¿åˆ†æ
    async function loadImportTrends() {
        try {
            const result = await fetchJson(`${api.trends}?days=30`);
            if (result.code === 1) {
                renderTrends(result.data);
                openDialog('dlg-trends');
            }
        } catch (error) {
            console.error('åŠ è½½è¶‹åŠ¿åˆ†æå¤±è´¥:', error);
            toast('åŠ è½½è¶‹åŠ¿åˆ†æå¤±è´¥ï¼š' + error.message);
        }
    }
    
    // æ¸²æŸ“è¶‹åŠ¿åˆ†æ
    function renderTrends(trends) {
        const content = document.getElementById('trends-content');
        
        const trendData = trends.trend_data || [];
        const totalSessions = trends.total_sessions || 0;
        const totalRows = trends.total_rows || 0;
        const totalInserted = trends.total_inserted || 0;
        
        let tableHtml = `
            <div class="form-grid">
                <label>åˆ†æå¤©æ•°: ${trends.days}å¤©</label>
                <label>æ€»æ‰¹æ¬¡: ${totalSessions}</label>
                <label>æ€»è¡Œæ•°: ${totalRows.toLocaleString()}</label>
                <label>æˆåŠŸå¯¼å…¥: ${totalInserted.toLocaleString()}</label>
                <label>å¹³å‡æ¯æ—¥æ‰¹æ¬¡: ${trends.average_sessions_per_day || 0}</label>
            </div>
        `;
        
        if (trendData.length > 0) {
            tableHtml += `
                <table style="margin-top: 16px;">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>æ‰¹æ¬¡æ•°é‡</th>
                            <th>æ€»è¡Œæ•°</th>
                            <th>æˆåŠŸå¯¼å…¥</th>
                            <th>é‡å¤è¡Œ</th>
                            <th>é”™è¯¯è¡Œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trendData.map(day => `
                            <tr>
                                <td>${day.import_date}</td>
                                <td>${day.session_count || 0}</td>
                                <td>${day.total_rows || 0}</td>
                                <td>${day.inserted_rows || 0}</td>
                                <td>${day.duplicate_rows || 0}</td>
                                <td>${day.error_rows || 0}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else {
            tableHtml += '<p class="muted">æš‚æ— è¶‹åŠ¿æ•°æ®</p>';
        }
        
        content.innerHTML = tableHtml;
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
    function formatDateTime(dateTimeStr) {
        if (!dateTimeStr) return '-';
        try {
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-CN');
        } catch (e) {
            return dateTimeStr;
        }
    }
    
    // é€‰æ‹©åŠŸèƒ½
    function toggleSessionSelection(sessionId) {
        if (selectedSessions.has(sessionId)) {
            selectedSessions.delete(sessionId);
        } else {
            selectedSessions.add(sessionId);
        }
        renderSessions(filteredSessions);
    }
    
    function toggleSelectAll() {
        const selectAll = document.getElementById('select-all-sessions');
        if (selectAll.checked) {
            filteredSessions.forEach(session => selectedSessions.add(session.id));
        } else {
            selectedSessions.clear();
        }
        renderSessions(filteredSessions);
    }
    
    function clearSelection() {
        selectedSessions.clear();
        document.getElementById('select-all-sessions').checked = false;
        renderSessions(filteredSessions);
    }
    
    function updateBatchActions() {
        const batchActions = document.getElementById('batch-actions');
        const selectedCount = document.getElementById('selected-count');
        
        if (selectedSessions.size > 0) {
            batchActions.style.display = 'block';
            selectedCount.textContent = `å·²é€‰æ‹© ${selectedSessions.size} ä¸ªæ‰¹æ¬¡`;
        } else {
            batchActions.style.display = 'none';
        }
        
        // æ›´æ–°å…¨é€‰çŠ¶æ€
        const selectAll = document.getElementById('select-all-sessions');
        if (filteredSessions.length === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        } else if (selectedSessions.size === filteredSessions.length) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else if (selectedSessions.size > 0) {
            selectAll.checked = false;
            selectAll.indeterminate = true;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        }
    }
    
    // æ‰¹é‡æ“ä½œ
    async function batchReprocess() {
        if (selectedSessions.size === 0) {
            toast('è¯·å…ˆé€‰æ‹©è¦é‡æ–°å¤„ç†çš„æ‰¹æ¬¡');
            return;
        }
        
        if (!confirm(`ç¡®è®¤é‡æ–°å¤„ç†é€‰ä¸­çš„ ${selectedSessions.size} ä¸ªæ‰¹æ¬¡ï¼Ÿ`)) {
            return;
        }
        
        try {
            const promises = Array.from(selectedSessions).map(id => 
                fetchJson(`${api.sessions}/${id}/reprocess`, { method: 'POST' })
            );
            
            const results = await Promise.allSettled(promises);
            const successCount = results.filter(r => r.status === 'fulfilled' && r.value.code === 1).length;
            
            toast(`é‡æ–°å¤„ç†å®Œæˆï¼šæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${selectedSessions.size - successCount} ä¸ª`);
            clearSelection();
            loadImportSessions();
            loadStatistics();
        } catch (error) {
            console.error('æ‰¹é‡é‡æ–°å¤„ç†å¤±è´¥:', error);
            toast('æ‰¹é‡é‡æ–°å¤„ç†å¤±è´¥ï¼š' + error.message);
        }
    }
    
    async function batchDelete() {
        if (selectedSessions.size === 0) {
            toast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ‰¹æ¬¡');
            return;
        }
        
        if (!confirm(`ç¡®è®¤åˆ é™¤é€‰ä¸­çš„ ${selectedSessions.size} ä¸ªæ‰¹æ¬¡ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç›¸å…³è´¦å•æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            return;
        }
        
        try {
            const promises = Array.from(selectedSessions).map(id => 
                fetchJson(`${api.sessions}/${id}`, { method: 'DELETE' })
            );
            
            const results = await Promise.allSettled(promises);
            const successCount = results.filter(r => r.status === 'fulfilled' && r.value.code === 1).length;
            
            toast(`åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${selectedSessions.size - successCount} ä¸ª`);
            clearSelection();
            loadImportSessions();
            loadStatistics();
        } catch (error) {
            console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
            toast('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼š' + error.message);
        }
    }
    
    function batchExport() {
        if (selectedSessions.size === 0) {
            toast('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„æ‰¹æ¬¡');
            return;
        }
        
        const selectedSessionsArray = Array.from(selectedSessions);
        const csvData = generateCSV(selectedSessionsArray);
        downloadCSV(csvData, `import-sessions-${new Date().toISOString().split('T')[0]}.csv`);
        toast(`å·²å¯¼å‡º ${selectedSessions.size} ä¸ªæ‰¹æ¬¡çš„æ•°æ®`);
    }
    
    function exportSessions() {
        const csvData = generateCSV(filteredSessions.map(s => s.id));
        downloadCSV(csvData, `all-import-sessions-${new Date().toISOString().split('T')[0]}.csv`);
        toast('å·²å¯¼å‡ºæ‰€æœ‰æ‰¹æ¬¡æ•°æ®');
    }
    
    function generateCSV(sessionIds) {
        const headers = ['æ‰¹æ¬¡ID', 'æ–‡ä»¶å', 'æ–‡ä»¶ç±»å‹', 'æ€»è¡Œæ•°', 'æˆåŠŸå¯¼å…¥', 'é‡å¤è¡Œ', 'é”™è¯¯è¡Œ', 'æˆåŠŸç‡', 'å¯¼å…¥æ—¶é—´'];
        const rows = sessionIds.map(id => {
            const session = allSessions.find(s => s.id === id);
            if (!session) return null;
            
            const successRate = session.totalRows > 0 ? 
                (session.insertedRows * 100 / session.totalRows).toFixed(1) : '0.0';
            
            return [
                session.id,
                session.fileName || '',
                session.sourceType || '',
                session.totalRows || 0,
                session.insertedRows || 0,
                session.duplicateRows || 0,
                session.errorRows || 0,
                successRate + '%',
                formatDateTime(session.importTime)
            ];
        }).filter(row => row !== null);
        
        return [headers, ...rows].map(row => 
            row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
        ).join('\n');
    }
    
    function downloadCSV(csvData, filename) {
        const blob = new Blob(['\ufeff' + csvData], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }
    
    // å·¥å…·å‡½æ•°
    function showLoading(elementId, message) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<tr><td colspan="12" class="muted">${message}</td></tr>`;
    }
    
    function showError(elementId, message) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<tr><td colspan="12" class="error">${message}</td></tr>`;
    }
    
    // ç»‘å®šäº‹ä»¶
    document.getElementById('btn-delete-session').addEventListener('click', () => deleteSession(currentSessionId));
    document.getElementById('btn-reprocess-session').addEventListener('click', () => reprocessSession(currentSessionId));
    
    // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæœ¬æœˆç¬¬ä¸€å¤©åˆ°ä»Šå¤©ï¼‰
    function setDefaultDateRange() {
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸå€¼
        document.getElementById('filter-date-from').value = formatDate(firstDayOfMonth);
        document.getElementById('filter-date-to').value = formatDate(today);
    }
    
    // é‡ç½®æ—¥æœŸè¿‡æ»¤å™¨
    function resetDateFilter() {
        setDefaultDateRange();
        filterSessions();
        toast('æ—¥æœŸè¿‡æ»¤å™¨å·²é‡ç½®ä¸ºæœ¬æœˆèŒƒå›´');
    }
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('load', () => {
        setDefaultDateRange();
        loadStatistics();
        loadImportSessions();
    });
    </script>
</body>
</html>
