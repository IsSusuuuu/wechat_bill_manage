<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>导入批次功能测试 - 微信财务监控系统</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <header class="app-header">
        <h1>导入批次功能测试</h1>
        <nav class="nav">
            <a href="/index.html">首页</a>
            <a href="/import-sessions.html">导入批次管理</a>
        </nav>
    </header>
    <main class="container">
        <section class="card">
            <h2>API测试</h2>
            <div class="toolbar">
                <button class="btn" onclick="testStatistics()">测试统计API</button>
                <button class="btn" onclick="testSessions()">测试批次列表API</button>
                <button class="btn" onclick="testTrends()">测试趋势分析API</button>
                <button class="btn" onclick="testCreateSession()">测试创建批次</button>
                <button class="btn" onclick="testDateFilter()">测试日期筛选</button>
            </div>
            <div id="test-results" style="background: #1a1a1a; padding: 16px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; margin-top: 16px;"></div>
        </section>
        
        <section class="card">
            <h2>功能演示</h2>
            <div class="toolbar">
                <button class="btn" onclick="loadDemoData()">加载演示数据</button>
                <button class="btn" onclick="simulateImport()">模拟导入过程</button>
                <button class="btn" onclick="clearResults()">清空结果</button>
            </div>
            <div id="demo-results" style="margin-top: 16px;"></div>
        </section>
    </main>

    <script src="/utils.js"></script>
    <script>
    function log(message) {
        const results = document.getElementById('test-results');
        const timestamp = new Date().toLocaleTimeString();
        results.textContent += `[${timestamp}] ${message}\n`;
        results.scrollTop = results.scrollHeight;
        console.log(message);
    }

    async function testStatistics() {
        try {
            log('测试统计API...');
            const result = await fetchJson('/api/import-sessions/statistics');
            log(`统计API响应: ${JSON.stringify(result, null, 2)}`);
        } catch (error) {
            log(`统计API测试失败: ${error.message}`);
        }
    }

    async function testSessions() {
        try {
            log('测试批次列表API...');
            const result = await fetchJson('/api/import-sessions');
            log(`批次列表API响应: ${JSON.stringify(result, null, 2)}`);
        } catch (error) {
            log(`批次列表API测试失败: ${error.message}`);
        }
    }

    async function testTrends() {
        try {
            log('测试趋势分析API...');
            const result = await fetchJson('/api/import-sessions/trends?days=30');
            log(`趋势分析API响应: ${JSON.stringify(result, null, 2)}`);
        } catch (error) {
            log(`趋势分析API测试失败: ${error.message}`);
        }
    }

    async function testCreateSession() {
        try {
            log('测试创建批次...');
            const sessionData = {
                sourceType: '测试导入',
                fileName: 'test-import.xlsx',
                totalRows: 100,
                insertedRows: 95,
                duplicateRows: 3,
                errorRows: 2,
                importTime: new Date().toISOString()
            };
            
            // 注意：这里只是演示，实际创建需要后端支持
            log(`模拟创建批次数据: ${JSON.stringify(sessionData, null, 2)}`);
        } catch (error) {
            log(`创建批次测试失败: ${error.message}`);
        }
    }

    function loadDemoData() {
        const demoResults = document.getElementById('demo-results');
        demoResults.innerHTML = `
            <h3>演示数据</h3>
            <div class="form-grid">
                <div>
                    <h4>导入统计概览</h4>
                    <p>总导入批次: 15</p>
                    <p>总导入行数: 2,450</p>
                    <p>成功导入: 2,320</p>
                    <p>重复行数: 89</p>
                    <p>错误行数: 41</p>
                    <p>成功率: 94.7%</p>
                </div>
                <div>
                    <h4>最近批次</h4>
                    <ul>
                        <li>批次 #15: 微信支付账单(2024-10-05).xlsx - 成功</li>
                        <li>批次 #14: 微信支付账单(2024-10-04).xlsx - 部分成功</li>
                        <li>批次 #13: 微信支付账单(2024-10-03).xlsx - 成功</li>
                    </ul>
                </div>
            </div>
        `;
    }

    function simulateImport() {
        const demoResults = document.getElementById('demo-results');
        demoResults.innerHTML = `
            <h3>模拟导入过程</h3>
            <div id="import-progress">
                <p>正在解析文件...</p>
                <div style="background: #333; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div id="progress-bar" style="background: #007bff; height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
                <p id="progress-text">0%</p>
            </div>
        `;
        
        // 模拟进度条
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 20;
            if (progress > 100) progress = 100;
            
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').textContent = Math.round(progress) + '%';
            
            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    document.getElementById('import-progress').innerHTML = `
                        <p style="color: #28a745;">✅ 导入完成！</p>
                        <p>成功导入: 156 条记录</p>
                        <p>重复记录: 3 条</p>
                        <p>错误记录: 1 条</p>
                        <p>成功率: 97.5%</p>
                    `;
                }, 500);
            }
        }, 200);
    }

    function testDateFilter() {
        log('测试日期筛选功能...');
        
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const fromDate = formatDate(firstDayOfMonth);
        const toDate = formatDate(today);
        
        log(`默认日期范围: ${fromDate} 到 ${toDate}`);
        log(`今天: ${toDate}`);
        log(`本月第一天: ${fromDate}`);
        
        // 测试日期过滤逻辑
        const mockSessions = [
            { importTime: '2024-10-01T10:30:00' },
            { importTime: '2024-10-15T14:20:00' },
            { importTime: '2024-10-30T09:15:00' },
            { importTime: '2024-11-01T16:45:00' }
        ];
        
        const filtered = mockSessions.filter(session => {
            const sessionDate = new Date(session.importTime);
            const from = new Date(fromDate);
            const to = new Date(toDate);
            to.setHours(23, 59, 59, 999);
            return sessionDate >= from && sessionDate <= to;
        });
        
        log(`模拟数据过滤结果: ${filtered.length} 个批次在范围内`);
        log('✅ 日期筛选功能测试完成');
    }

    function clearResults() {
        document.getElementById('test-results').textContent = '';
        document.getElementById('demo-results').innerHTML = '';
    }

    // 页面加载时自动运行一些测试
    window.addEventListener('load', () => {
        log('页面加载完成，开始测试...');
        testStatistics();
    });
    </script>
</body>
</html>
